<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluaciones neuropsicol√≥gicas online</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <!-- React + Babel CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useRef, useEffect, useMemo, useCallback } = React;

    // Utils --------------------------------------------------
    function cls(...xs){ return xs.filter(Boolean).join(" "); }
    function pct(x){ return Math.round(x*100); }
    function download(filename, text){
      const a=document.createElement('a');
      a.href='data:application/json;charset=utf-8,'+encodeURIComponent(text);
      a.download=filename; a.style.display='none';
      document.body.appendChild(a); a.click(); a.remove();
    }
    const defer = (fn) => (...args) => requestAnimationFrame(() => fn(...args));

    // --- Persistencia b√°sica para reanudaci√≥n ---
    const SAVE_KEY = 'efx.save.v1';
    function loadSave(){ try { return JSON.parse(localStorage.getItem(SAVE_KEY)||'{}'); } catch { return {}; } }
    function saveState(patch){ try { const cur = loadSave(); const next = {...cur, ...patch}; localStorage.setItem(SAVE_KEY, JSON.stringify(next)); } catch {} }
    function clearSave(){ try { localStorage.removeItem(SAVE_KEY); } catch {} }

    // Apps Script endpoint (CORS habilitado)
    const SHEETS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyOFzNACPiTHI4ZIS-Ch3Lcs9NQ0SDf4WVVbPl7zmZybT08v5BHlppvZMBHWOB615qC/exec';

    // === OFFLINE OUTBOX + runId (para sincronizar al reconectar) ===
    function uuidv4(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);}); }
    const RUN_KEY='efx.runId.v1';
    function getRunId(){ let id=localStorage.getItem(RUN_KEY); if(!id){ id=uuidv4(); localStorage.setItem(RUN_KEY,id);} return id; }
    const OUTBOX_KEY='efx.outbox.v1';
    function readOutbox(){ try{ return JSON.parse(localStorage.getItem(OUTBOX_KEY)||'[]'); }catch{return [];} }
    function writeOutbox(list){ try{ localStorage.setItem(OUTBOX_KEY, JSON.stringify(list)); }catch{} }
    function enqueueOutbox(item){ const q=readOutbox(); q.push(item); writeOutbox(q); }
    async function flushOutbox(){
      const q=readOutbox(); if(!q.length) return;
      const rest=[];
      for(const it of q){
        try{
          await fetch(it.url, {method:'POST', mode:'cors', headers:{'Content-Type':'application/json'}, body: it.body, keepalive:true});
        }catch(e){ rest.push(it); }
      }
      writeOutbox(rest);
    }
    window.addEventListener('online', flushOutbox);
    window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden'){ flushOutbox(); }});

    // Env√≠o robusto: CORS ‚Üí sendBeacon ‚Üí GET b64 ‚Üí Outbox
    async function sendToSheets(payload){
      if(!SHEETS_ENDPOINT) return;
      const bodyStr = JSON.stringify(payload);

      // Si no hay red, encolamos y salimos
      if(!navigator.onLine){ enqueueOutbox({url:SHEETS_ENDPOINT, body: bodyStr}); return; }

      // 1) Intento principal: fetch CORS
      try{
        await fetch(SHEETS_ENDPOINT, {
          method:'POST',
          mode:'cors',
          headers:{'Content-Type':'application/json'},
          body: bodyStr,
          keepalive: true,
          cache: 'no-cache'
        });
        return; // √©xito
      }catch(e){ /* sigue a fallback */ }

      // 2) Fallback: sendBeacon
      try{
        if(navigator.sendBeacon){
          const ok = navigator.sendBeacon(SHEETS_ENDPOINT, new Blob([bodyStr], {type:'application/json'}));
          if(ok) return;
        }
      }catch(e){ /* sigue a fallback */ }

      // 3) Fallback: GET con base64 (Apps Script doGet soporta ?b64=)
      try{
        const b64 = btoa(unescape(encodeURIComponent(bodyStr)));
        new Image().src = SHEETS_ENDPOINT + '?b64=' + encodeURIComponent(b64) + '&ts=' + Date.now();
        return;
      }catch(e){ /* √∫ltimo recurso: encolar */ }

      // 4) √öltimo recurso: encolar para reintento posterior
      enqueueOutbox({url:SHEETS_ENDPOINT, body: bodyStr});
    }

    // M√©tricas -----------------------------------------------
    function accuracy(trials){
      const v = trials.filter(t => t.correct !== undefined);
      return v.length ? v.filter(t => !!t.correct).length / v.length : 0;
    }
    function meanRt(trials){
      const v = trials.map(t => t.rtMs).filter(x => typeof x === 'number' && isFinite(x));
      return v.length ? Math.round(v.reduce((a,b)=>a+b,0)/v.length) : null;
    }
    function computeScores(trials){
      const by = trials.reduce((m,t)=>{ (m[t.task]=m[t.task]||[]).push(t); return m; }, {});
      return Object.entries(by).map(([task,arr])=>{
        const s = { task, acc:accuracy(arr), rt:meanRt(arr) };
        if (task === 'hanoi') s.moves = arr.filter(tr => tr.correct === true).length;
        return s;
      });
    }
    function buildPayload(participant,trials,status){
      return {
        runId: getRunId(),
        participant,
        completedAt: new Date().toISOString(),
        status, // 'completed' | 'cancelled'
        scores: computeScores(trials),
        trials
      };
    }

    // App ----------------------------------------------------
    function App(){
      const [view,setView]=useState('start');           // start | consent | check | run | report
      const [firstTask,setFirstTask]=useState('stroop');
      const [order,setOrder]=useState(['stroop','hanoi','corsi','digit']);
      const [participant,setParticipant]=useState({name:'',idNumber:'',community:'',birthDate:''});
      const trialsRef=useRef([]);
      const [report,setReport]=useState(null);
      const [askCancel,setAskCancel] = useState(false);

      // Defer setters de navegaci√≥n para evitar setState durante render
      const setViewDeferred = useCallback(defer(setView), []);

      // Reanudar si existe estado guardado
      useEffect(()=>{
        const s = loadSave();
        if (s && s.view && s.view !== 'report'){
          const wants = confirm('Se detect√≥ una evaluaci√≥n previa sin terminar. ¬øDeseas reanudarla?');
          if (wants){
            setParticipant(s.participant || {name:'',idNumber:'',community:'',birthDate:''});
            setOrder(s.order || ['stroop','hanoi','corsi','digit']);
            trialsRef.current = Array.isArray(s.trials) ? s.trials : [];
            setViewDeferred(s.view || 'start');
          } else {
            clearSave();
          }
        }
      },[setViewDeferred]);

      // Guardar progreso clave
      useEffect(()=>{ try{ flushOutbox(); }catch{} }, []);
      useEffect(()=>{ saveState({ view, order }); }, [view, order]);
      useEffect(()=>{ saveState({ participant }); }, [participant]);

      const onTrialCapture = useCallback((t)=>{
        trialsRef.current.push(t);
        saveState({ trials: trialsRef.current });
      },[]);

      function begin(){
        if(!participant.name.trim() || !participant.idNumber.trim())
          return alert('Ingresa nombre e ID.');
        const all=['stroop','hanoi','corsi','digit'];
        setOrder([firstTask, ...all.filter(k=>k!==firstTask)]);
        setViewDeferred('consent');
      }

      function onAllDone(){
        const payload = buildPayload(participant, trialsRef.current, 'completed');
        sendToSheets(payload);
        setReport(payload);
        setViewDeferred('report');
        clearSave();
        setTimeout(()=>document.getElementById('report-root')?.scrollIntoView({behavior:'smooth', block:'start'}), 50);
      }
      function onCancel(){
        const payload = buildPayload(participant, trialsRef.current, 'cancelled');
        sendToSheets(payload);
        setReport(payload);
        setViewDeferred('report');
        clearSave();
        setTimeout(()=>document.getElementById('report-root')?.scrollIntoView({behavior:'smooth', block:'start'}), 50);
      }

      return (
        <div className="min-h-screen text-slate-900">
          <div className="mx-auto max-w-3xl p-6 space-y-6">
            <header className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-8 h-8 rounded-xl bg-slate-900"></div>
                <div>
                  <h1 className="text-xl font-bold">Evaluaciones neuropsicol√≥gicas online</h1>
                  <p className="text-xs text-slate-500">Demo ejecutable</p>
                </div>
              </div>
              <span className="text-xs text-slate-500">{view.toUpperCase()}</span>
            </header>

            {view==='start' && (
              <section className="space-y-4">
                <h2 className="text-lg font-semibold">Inicio</h2>
                <p className="text-slate-600 text-sm">Completar√°s todas las pruebas. Elige con cu√°l deseas empezar e ingresa tus datos.</p>
                <div className="grid gap-3 rounded-2xl border bg-white p-4">
                  <div className="grid gap-1">
                    <label className="text-xs text-slate-500">Nombres y apellidos</label>
                    <input className="rounded-xl border px-3 py-2"
                           value={participant.name}
                           onChange={e=>setParticipant(p=>({...p,name:e.target.value}))}
                           placeholder="Nombres y apellidos"/>
                  </div>
                  <div className="grid gap-1">
                    <label className="text-xs text-slate-500">ID (c√©dula / ID number)</label>
                    <input className="rounded-xl border px-3 py-2"
                           value={participant.idNumber}
                           onChange={e=>setParticipant(p=>({...p,idNumber:e.target.value}))}
                           placeholder="ID"/>
                  </div>
                  <div className="grid gap-1">
                    <label className="text-xs text-slate-500">Comunidad de procedencia</label>
                    <input className="rounded-xl border px-3 py-2"
                           value={participant.community}
                           onChange={e=>setParticipant(p=>({...p,community:e.target.value}))}
                           placeholder="Ej.: Los Encuentros"/>
                  </div>
                  <div className="grid gap-1">
                    <label className="text-xs text-slate-500">Fecha de nacimiento</label>
                    <input type="date" className="rounded-xl border px-3 py-2"
                           value={participant.birthDate}
                           onChange={e=>setParticipant(p=>({...p,birthDate:e.target.value}))}/>
                  </div>
                  <div className="grid gap-1">
                    <label className="text-xs text-slate-500">Primera prueba</label>
                    <select className="rounded-xl border px-3 py-2"
                            value={firstTask} onChange={e=>setFirstTask(e.target.value)}>
                      <option value="stroop">Stroop (interferencia)</option>
                      <option value="hanoi">Torre de Hanoi (planificaci√≥n)</option>
                      <option value="corsi">Corsi 3√ó3 (memoria visoespacial)</option>
                      <option value="digit">D√≠gitos (memoria verbal)</option>
                    </select>
                  </div>
                  <div className="flex gap-2 pt-2">
                    <button onClick={begin} className="rounded-xl bg-slate-900 text-white px-4 py-2">Continuar</button>
                  </div>
                  <ul className="text-sm text-slate-500 list-disc pl-5">
                    <li>Secuencia: Consentimiento ‚Üí Chequeo ‚Üí Tareas ‚Üí Informe</li>
                    <li>Compatible teclado y pantalla t√°ctil</li>
                  </ul>
                </div>
              </section>
            )}

            {view==='consent' && <Consent onAccept={()=>setViewDeferred('check')} onDecline={()=>setViewDeferred('start')} />}
            {view==='check' && <Check onContinue={()=>setViewDeferred('run')} />}
            {view==='run' && <Runner order={order} onTrial={onTrialCapture} onDone={onAllDone} onRequestCancel={()=>setAskCancel(true)} />}
            {askCancel && <ConfirmCancel onConfirm={()=>{ setAskCancel(false); onCancel(); }} onCancel={()=>setAskCancel(false)} />}
            {view==='report' && report && <Report payload={report} onRestart={()=>{ trialsRef.current=[]; setReport(null); setViewDeferred('start'); }} />}
          </div>
        </div>
      );
    }

    // Consentimiento -----------------------------------------
    function Consent({onAccept,onDecline}){
      const [ok,setOk]=useState(false);
      return (
        <section className="space-y-4">
          <h2 className="text-lg font-semibold">Consentimiento informado</h2>
          <div className="rounded-2xl border p-4 bg-white text-sm leading-relaxed text-slate-700 max-h-64 overflow-auto">
            <p><b>Prop√≥sito:</b> evaluar funciones cognitivas mediante tareas breves en l√≠nea.</p>
            <p><b>Duraci√≥n:</b> 8‚Äì12 minutos. Puede tomar descansos si lo necesita.</p>
            <p><b>Riesgos:</b> m√≠nimos (fatiga/aburrimiento).</p>
            <p><b>Datos:</b> se recogen tiempos de reacci√≥n, aciertos/errores y metadatos t√©cnicos.</p>
          </div>
          <label className="flex items-start gap-2 text-sm">
            <input type="checkbox" checked={ok} onChange={e=>setOk(e.target.checked)} className="mt-1"/>
            <span>He le√≠do y acepto participar.</span>
          </label>
          <div className="flex gap-2">
            <button disabled={!ok} onClick={onAccept} className={cls("rounded-xl px-4 py-2", ok?"bg-slate-900 text-white":"bg-slate-200 text-slate-400 cursor-not-allowed")}>Continuar</button>
            <button onClick={onDecline} className="rounded-xl border px-4 py-2">Cancelar</button>
          </div>
        </section>
      );
    }

    // Chequeo -------------------------------------------------
    function Check({onContinue}){
      const [okKey,setOkKey]=useState(false);
      const [okScreen,setOkScreen]=useState(false);
      const [okFocus,setOkFocus]=useState(true);
      useEffect(()=>{
        const w=()=>setOkScreen(innerWidth>=360&&innerHeight>=500); w();
        addEventListener('resize',w);
        const vis=()=>setOkFocus(!document.hidden);
        document.addEventListener('visibilitychange',vis);
        return ()=>{ removeEventListener('resize',w); document.removeEventListener('visibilitychange',vis); };
      },[]);
      useEffect(()=>{
        const onKey=e=>{ if(e.code==='Space') setOkKey(true); };
        addEventListener('keydown',onKey);
        return ()=>removeEventListener('keydown',onKey);
      },[]);
      const ok=okScreen&&okFocus;
      return (
        <section className="space-y-3">
          <h2 className="text-lg font-semibold">Chequeo de dispositivo</h2>
          <ul className="text-sm text-slate-700 grid gap-1">
            <li>üì± Tama√±o de pantalla: {okScreen?"OK":"Muy peque√±o"}</li>
            <li>ü™ü Ventana activa: {okFocus?"OK":"Volviste desde otra pesta√±a"}</li>
            <li>‚å®Ô∏è Teclado: {okKey?"Barra espaciadora detectada":"Pulsa barra espaciadora para probar"}</li>
          </ul>
          <button disabled={!ok} onClick={onContinue} className={cls("rounded-xl px-4 py-2", ok?"bg-slate-900 text-white":"bg-slate-200 text-slate-400 cursor-not-allowed")}>Comenzar evaluaci√≥n</button>
        </section>
      );
    }

    // Runner --------------------------------------------------
    function Runner({order,onTrial,onDone,onRequestCancel}){
      // Arranque desde el √≠ndice de tarea guardado (si existe)
      const saved = loadSave();
      const startI = typeof saved.runIndex==='number' ? saved.runIndex : 0;
      const [i,setI]=useState(startI);
      const tasks=useMemo(()=>({stroop:Stroop,hanoi:Hanoi,corsi:Corsi,digit:DigitSpan}),[]);
      const key=order[i]; const Comp=tasks[key];

      // Progreso por tarea (ensayos completados) para reanudar dentro de cada una
      const progress = useMemo(()=>{
        const cnt={}; const s=loadSave();
        const list = Array.isArray(s.trials)? s.trials : [];
        for(const t of list){ cnt[t.task]=(cnt[t.task]||0)+1; }
        return cnt;
      },[]);

      const setINextDeferred = useCallback(defer((val)=>{ setI(val); saveState({runIndex: val}); }), []);
      const handleDone = () => {
        if(i+1<order.length) setINextDeferred(i+1); else onDone();
      };

      return (
        <section className="space-y-4">
          <div className="flex items-center justify-between text-sm text-slate-500">
            <span>Tarea {i+1} / {order.length}</span>
            <button onClick={onRequestCancel} className="rounded-lg border px-3 py-1 text-xs">Cancelar evaluaci√≥n</button>
          </div>
          <div className="rounded-2xl border bg-white p-4">
            {Comp? <Comp onTrial={onTrial} onDone={handleDone} startAt={progress[key]||0} /> : <div>No encontrada: {String(key)}</div>}
          </div>
        </section>
      );
    }

    // Stroop --------------------------------------------------
    function Stroop({onTrial,onDone,startAt=0}){
      const COLORS=[
        {name:'ROJO', css:'text-red-600', key:'R'},
        {name:'AZUL', css:'text-blue-600', key:'A'},
        {name:'VERDE', css:'text-green-600', key:'V'},
        {name:'AMARILLO', css:'text-yellow-500', key:'M'}
      ];
      const N_TRIALS=24;
      const schedule=useRef([...Array(12).fill('word'),...Array(12).fill('color')]
        .map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]));

      const [trial,setTrial]=useState(startAt);
      const [stim,setStim]=useState(null);
      const [mode,setMode]=useState('word'); // word | color
      const [opts,setOpts]=useState([]);
      const t0=useRef(0);

      function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
      function mkStim(){ let w=pick(COLORS), i=pick(COLORS); while(i.name===w.name){ i=pick(COLORS); } return {word:w,ink:i}; }

      useEffect(()=>{ next(startAt); },[startAt]);

      function next(idx){
        if(idx>=N_TRIALS){ onDone(); return; }
        const m = schedule.current[idx];
        const s = mkStim();
        const correctOpt = m==='word' ? s.word : s.ink;
        const wrongOpt = pick(COLORS.filter(c => c.name !== correctOpt.name));
        const shuffled = Math.random() < 0.5 ? [correctOpt, wrongOpt] : [wrongOpt, correctOpt];
        setMode(m);
        setStim(s);
        setOpts(shuffled);
        t0.current=performance.now();
      }

      function answer(sel){
        if(!stim) return;
        const rt=Math.round(performance.now()-t0.current);
        const isCorrect = mode==='word' ? (sel.name===stim.word.name) : (sel.name===stim.ink.name);
        const task = mode==='word'?'stroop_word':'stroop_color';
        const idx = trial;
        onTrial({ task, index:idx, stimulus:{word:stim.word.name,ink:stim.ink.name}, response:{choice:sel.name}, correct:isCorrect, rtMs:rt });
        const nt = idx+1; setTrial(nt); next(nt);
      }

      return (
        <div className="grid place-items-center gap-6">
          <div className="text-slate-600 text-sm text-center">{mode==='word' ? <>¬øQu√© <b>palabra</b> lees?</> : <>¬øQu√© <b>color</b> ves?</>}</div>
          {stim && <div className={cls('text-5xl font-bold', stim.ink.css)}>{stim.word.name}</div>}
          <div className="w-full max-w-xl grid gap-3">
            <div className="flex flex-wrap justify-center gap-2">
              {opts.map(c => (
                <button key={c.name} onClick={() => answer(c)}
                        className="rounded-xl border px-4 py-2 min-w-[6rem]">{c.name}</button>
              ))}
            </div>
          </div>
          <div className="text-xs text-slate-500">Ensayo {trial+1} / {N_TRIALS}</div>
        </div>
      );
    }

    // Hanoi ---------------------------------------------------
    function Hanoi({onTrial,onDone,startAt=0}){
      const N=3;
      const moveIdx=useRef(startAt);
      const tMove=useRef(performance.now());
      const roundsRef=useRef([[0,2],[1,2],[2,0],[2,1],[1,0],[1,2]]); // [from,to]
      const [round,setRound]=useState(0);
      const [pegs,setPegs]=useState([[],[],[]]);
      const [sel,setSel]=useState(null);

      function initRound(r){
        const [from]=roundsRef.current[r];
        const start=[[],[],[]];
        start[from]=Array.from({length:N},(_,i)=>N-i); // [3,2,1]
        setPegs(start); setSel(null); setRound(r);
      }

      useEffect(()=>{ initRound(0); },[]);

      function canPlace(d,t){ const top=t[t.length-1]; return top===undefined || top>d; }
      function colorFor(d){ if(d===3) return '#eab308'; if(d===2) return '#16a34a'; return '#2563eb'; }

      function click(pi){
        if(sel===null){ if(pegs[pi].length===0) return; setSel(pi); return; }
        if(sel===pi){ setSel(null); return; }
        const from=sel, to=pi;
        const src=pegs[from]; if(src.length===0){ setSel(null); return; }
        const disc=src[src.length-1];
        const valid=canPlace(disc,pegs[to]);
        const rt=Math.round(performance.now()-tMove.current); tMove.current=performance.now();
        const [reqFrom, reqTo]=roundsRef.current[round];

        onTrial({task:'hanoi', index:moveIdx.current++, stimulus:{from,to,disc,state:pegs,required:[reqFrom,reqTo],round}, response:{move:[from,to]}, correct:valid, rtMs:rt});

        if(!valid){ setSel(null); return; }

        setPegs(p=>{
          const n=p.map(a=>a.slice()); n[from].pop(); n[to].push(disc);
          const done = n[reqTo].length===N;
          if(done){
            setTimeout(()=>{
              if(round+1 < roundsRef.current.length){ initRound(round+1); }
              else { onDone(); }
            }, 350);
          }
          return n;
        });
        setSel(null);
      }

      const [reqFrom, reqTo]=roundsRef.current[round]||[0,2];
      return (
        <div className="space-y-4">
          <div className="text-slate-600 text-sm text-center">Selecciona <b>origen</b> y luego <b>destino</b>. Debes mover <b>todos</b> los discos desde <b>{`T${reqFrom+1}`}</b> hasta <b>{`T${reqTo+1}`}</b>.</div>
          <div className="text-center text-xs text-slate-500">Ronda {round+1} / {roundsRef.current.length} ‚Äî Objetivo: <b>{`T${reqFrom+1} ‚Üí T${reqTo+1}`}</b></div>
          <div className="w-full overflow-hidden">
            <div className="flex flex-nowrap gap-4 justify-center items-end mx-auto">
              {pegs.map((peg,pi)=>(
                <button key={pi} onClick={()=>click(pi)}
                        className={cls('relative h-56 w-60 rounded-xl bg-white grid place-items-end border border-slate-200', sel===pi ? 'border-2 border-slate-900' : '')}
                        title={`Torre ${pi+1}`}>
                  <div className="absolute left-1/2 -translate-x-1/2 bottom-6 w-1 bg-slate-300 h-40"></div>
                  <div className="absolute left-3 right-3 bottom-4 h-2 bg-slate-300 rounded"></div>
                  <div className="w-full flex flex-col-reverse items-center gap-1 pb-6">
                    {peg.map((d,idx)=>(
                      <div key={idx} className="h-6 rounded text-[10px] text-white grid place-items-center"
                           style={{width:`${40+d*15}%`, background:colorFor(d)}}>{d}</div>
                    ))}
                  </div>
                  <div className="absolute top-2 right-2 text-[10px] text-slate-400">{`T${pi+1}`}</div>
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // Corsi 3√ó3 -----------------------------------------------
    function Corsi({onTrial,onDone,startAt=0}){
      const [trial,setTrial]=useState(startAt);
      const [phase,setPhase]=useState('show'); // show | input | final
      const [seq,setSeq]=useState([]);
      const [flash,setFlash]=useState(null);
      const [resp,setResp]=useState([]);
      const timerRef=useRef(null);
      const inputStartRef=useRef(null); // RT desde fin de memorizaci√≥n
      const trialRef=useRef(startAt);

      useEffect(()=>{ next(startAt); return()=>clearInterval(timerRef.current); },[startAt]);

      function shuffle(a){ return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]); }
      function pickSeq(len){ const cells=Array.from({length:9},(_,i)=>i); return shuffle(cells).slice(0,len); }

      function next(idx){
        if(idx>=9){ onDone(); return; }
        trialRef.current = idx; setTrial(idx);
        const len=3+Math.floor(idx/3); // 3,3,3,4,4,4,5,5,5
        const s=pickSeq(len);
        setSeq(s); setResp([]); setPhase('show');
        let i=0;
        timerRef.current=setInterval(()=>{
          setFlash(s[i]); i++;
          if(i>=s.length){
            clearInterval(timerRef.current);
            setTimeout(()=>{ setFlash(null); setPhase('input'); inputStartRef.current=performance.now(); }, 600);
          }
        },700);
      }

      function press(i){
        const idx = trialRef.current;
        if(phase!=='input') return;
        const r=[...resp,i]; setResp(r);
        if(r.length===seq.length){
          const correct=JSON.stringify(r)===JSON.stringify(seq);
          const rt=Math.round(performance.now()-inputStartRef.current);
          onTrial({task:'corsi', index:idx, stimulus:{seq}, response:{seq:r}, correct, rtMs:rt});
          setPhase('final'); setTimeout(()=>{ next(idx+1); },300);
        }
      }

      return (
        <div className="space-y-4">
          <div className="text-slate-600 text-sm text-center">Repite la secuencia tocando los cuadros en el <b>mismo orden</b>.</div>
          <div className="grid grid-cols-3 gap-3 w-64 mx-auto">
            {Array.from({length:9},(_,i)=>{
              const show=phase==='show'&&flash===i;
              const pressed=(phase==='input' || phase==='final') && resp.includes(i);
              const clsCell=show?'bg-slate-900 border-slate-900'
                :(pressed?'bg-emerald-500 border-emerald-600':'bg-white border-slate-300');
              return <button key={i} onClick={()=>press(i)} className={cls('aspect-square rounded border transition-colors', clsCell)} />;
            })}
          </div>
          <div className="text-center text-xs text-slate-500">Ensayo {trial+1} / 9</div>
        </div>
      );
    }

    // Digit Span (memoria de trabajo verbal) ------------------
    function DigitSpan({onTrial,onDone,startAt=0}){
      // 8 ensayos (4 directos 3-6 y 4 inversos 3-6)
      const PLAN = [
        {dir:'forward', len:3}, {dir:'forward', len:4}, {dir:'forward', len:5}, {dir:'forward', len:6},
        {dir:'backward', len:3}, {dir:'backward', len:4}, {dir:'backward', len:5}, {dir:'backward', len:6},
      ];

      // --- Configuraci√≥n de temporizaci√≥n ---
      const PER_DIGIT_MS = 1100;                 // cada n√∫mero visible 1100 ms
      const GAP_AFTER_SEQUENCE_MS = 600;         // pausa tras exposici√≥n

      const [trial,setTrial]=useState(startAt);
      const [phase,setPhase]=useState('show'); // show | input | final
      const [seq,setSeq]=useState([]);
      const [flashIdx,setFlashIdx]=useState(-1);
      const [resp,setResp]=useState([]);
      const timerRef=useRef(null);
      const inputStartRef=useRef(null);
      const trialRef=useRef(startAt);

      useEffect(()=>{ next(startAt); return()=>clearInterval(timerRef.current); },[startAt]);

      function randDigits(n){ const digs=[]; for(let i=0;i<n;i++){ digs.push(Math.floor(Math.random()*9)+1); } return digs; }

      function next(idx){
        if(idx>=PLAN.length){ onDone(); return; }
        trialRef.current=idx; setTrial(idx);
        const {len}=PLAN[idx];
        const s=randDigits(len);
        setSeq(s); setResp([]); setPhase('show'); setFlashIdx(-1);
        let i=0;
        timerRef.current=setInterval(()=>{
          setFlashIdx(s[i]); i++;
          if(i>=s.length){
            clearInterval(timerRef.current);
            setTimeout(()=>{ setFlashIdx(-1); setPhase('input'); inputStartRef.current=performance.now(); }, GAP_AFTER_SEQUENCE_MS);
          }
        }, PER_DIGIT_MS);
      }

      function pressDigit(d){ if(phase==='input'){ setResp(r=>{ const n=[...r,d]; const need = PLAN[trialRef.current].len; if(n.length===need) submit(n); return n; }); } }
      function backspace(){ if(phase==='input' && resp.length){ setResp(r=>r.slice(0,-1)); } }
      function submit(rNow){
        const idx=trialRef.current; const {dir}=PLAN[idx];
        const expect = dir==='forward' ? seq : [...seq].reverse();
        const correct = JSON.stringify(rNow||resp)===JSON.stringify(expect);
        const rt=Math.round(performance.now()-inputStartRef.current);
        onTrial({task:'digit_span', index:idx, stimulus:{seq, direction:dir}, response:{seq:rNow||resp}, correct, rtMs:rt});
        setPhase('final'); setTimeout(()=>{ next(idx+1); }, 400);
      }

      useEffect(()=>{
        const onKey=(e)=>{
          if(!isFinite(e.key)){
            if(e.key==='Backspace'){ backspace(); }
            if(e.key==='Enter'){ if(phase==='input') submit(resp); }
            return;
          }
          const d = Number(e.key);
          if(d>=0 && d<=9) pressDigit(d);
        };
        document.addEventListener('keydown', onKey);
        return ()=>document.removeEventListener('keydown', onKey);
      },[phase,resp]);

      const {dir,len}=PLAN[trial] || {dir:'forward',len:3};
      const digits = [1,2,3,4,5,6,7,8,9,0];
      const display = phase==='show' ? (flashIdx>-1 ? String(flashIdx) : ' ')
                       : (resp.length? resp.join('') : '');

      return (
        <div className="space-y-4">
          <div className="text-slate-600 text-sm text-center">
            Recuerda la secuencia de n√∫meros y rep√≠tela {dir==='forward' ? <b>en el mismo orden</b> : <b>al rev√©s</b>}.
          </div>
          <div className="text-center text-xs text-slate-500">Ensayo {trial+1} / {PLAN.length} ‚Äî Longitud: {len} ‚Äî Modo: {dir==='forward'? 'Directo':'Inverso'}</div>

          <div className="grid place-items-center">
            <div className={cls('h-20 min-w-[12rem] grid place-items-center rounded-xl border text-3xl font-semibold', phase==='show'?'bg-slate-900 text-white':'bg-white')}>{display}</div>
          </div>

          <div className="mx-auto max-w-xs grid grid-cols-3 gap-2">
            {digits.slice(0,9).map(d=> (
              <button key={d} onClick={()=>pressDigit(d)} className="rounded-xl border py-3 text-lg">{d}</button>
            ))}
            <button onClick={backspace} className="rounded-xl border py-3 text-sm">Borrar</button>
            <button onClick={()=>pressDigit(0)} className="rounded-xl border py-3 text-lg">0</button>
            <button onClick={()=>submit(resp)} className="rounded-xl border py-3 text-sm">Listo</button>
          </div>
        </div>
      );
    }

    // Confirmaci√≥n de cancelaci√≥n ---------------------------------
    function ConfirmCancel({onConfirm,onCancel}){
      useEffect(()=>{
        const onKey = (e)=>{ if(e.key==='Escape') onCancel(); };
        document.addEventListener('keydown', onKey);
        return ()=>document.removeEventListener('keydown', onKey);
      },[onCancel]);
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/40">
          <div className="w-full max-w-sm rounded-2xl bg-white p-5 shadow-lg">
            <h3 className="font-semibold text-lg mb-2">Terminar evaluaci√≥n</h3>
            <p className="text-sm text-slate-600 mb-4">¬øDeseas terminar y ver el informe con lo respondido?</p>
            <div className="flex gap-2 justify-end">
              <button onClick={onCancel} className="rounded-lg border px-3 py-2">Seguir</button>
              <button onClick={onConfirm} className="rounded-lg bg-slate-900 text-white px-3 py-2">Terminar y ver informe</button>
            </div>
          </div>
        </div>
      );
    }

    // Reporte -------------------------------------------------
    function Report({payload,onRestart}){
      const {participant,completedAt,scores,trials,status}=payload;
      const by=useMemo(()=>{ const m={}; for(const t of trials){ (m[t.task]=m[t.task]||[]).push(t); } return m; },[trials]);
      return (
        <section id="report-root" className="space-y-4">
          <h2 className="text-lg font-semibold">Informe de resultados</h2>
          <div className="text-xs text-slate-500">{participant?.name||'Participante'} ¬∑ ID: {participant?.idNumber||'‚Äî'} ¬∑ Comunidad: {participant?.community||'‚Äî'} ¬∑ F. nac.: {participant?.birthDate||'‚Äî'} ¬∑ {new Date(completedAt).toLocaleString()} ¬∑ Estado: <b>{status==='cancelled'?'CANCELADA':'COMPLETADA'}</b></div>
          <div className="grid gap-3">
            {scores.map(s=> (
              <div key={s.task} className="rounded-2xl border p-4 bg-white">
                <div className="font-semibold mb-1">{s.task.toUpperCase()}</div>
                <div className="text-sm">Exactitud: {pct(s.acc)}%</div>
                <div className="text-sm">RT medio: {s.rt??'‚Äî'} ms</div>
                {s.task==='hanoi' && <div className="text-sm">Movimientos (v√°lidos): {s.moves??'‚Äî'}</div>}
                <details open className="text-xs text-slate-500 mt-2">
                  <summary>Ver ensayos ({by[s.task]?.length||0})</summary>
                  <div className="overflow-auto max-h-48 mt-1">
                    <table className="w-full text-xs">
                      <thead><tr><th className="text-left">#</th><th className="text-left">Stim</th><th className="text-left">Resp</th><th>‚úî</th><th className="text-right">RT</th></tr></thead>
                      <tbody>
                        {(by[s.task]||[]).map((t,i)=>(
                          <tr key={i} className="border-t">
                            <td>{t.index}</td>
                            <td className="pr-2"><code className="text-[10px]">{JSON.stringify(t.stimulus)}</code></td>
                            <td className="pr-2"><code className="text-[10px]">{JSON.stringify(t.response)}</code></td>
                            <td>{t.correct?'‚úî':'‚úñ'}</td>
                            <td className="text-right">{t.rtMs??'‚Äî'}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </details>
              </div>
            ))}
          </div>
          <div className="flex gap-2">
            <button onClick={()=>window.print()} className="rounded-xl border px-4 py-2">Imprimir / PDF</button>
            <button onClick={()=>download('informe_'+(participant?.idNumber||'anon')+'.json', JSON.stringify(payload,null,2))} className="rounded-xl bg-slate-900 text-white px-4 py-2">Exportar JSON</button>
            <button onClick={()=>{ clearSave(); onRestart(); }} className="rounded-xl border px-4 py-2">Nueva evaluaci√≥n</button>
          </div>
        </section>
      );
    }

    // --------------------------------------------------------
    // Pruebas r√°pidas (unit tests ligeros en consola)
    (function runLightTests(){
      try{
        console.assert(accuracy([]) === 0, 'accuracy([]) debe ser 0');
        console.assert(meanRt([{rtMs:100},{rtMs:200},{rtMs:300}]) === 200, 'meanRt promedio');
        const sched = [...Array(12).fill('word'),...Array(12).fill('color')];
        console.assert(sched.length===24, 'Stroop debe tener 24 entradas');
        console.assert(sched.filter(x=>x==='word').length===12 && sched.filter(x=>x==='color').length===12, '12 word y 12 color');
        const s=[1,2,3]; const expectRev=[...s].reverse();
        console.assert(JSON.stringify(expectRev)==='[3,2,1]','DigitSpan reverse OK');
        // Nuevos tests
        const PLAN_TEST = [
          {dir:'forward', len:3}, {dir:'forward', len:4}, {dir:'forward', len:5}, {dir:'forward', len:6},
          {dir:'backward', len:3}, {dir:'backward', len:4}, {dir:'backward', len:5}, {dir:'backward', len:6},
        ];
        console.assert(PLAN_TEST.length===8, 'DigitSpan debe tener 8 ensayos');
        console.assert(PLAN_TEST.filter(p=>p.dir==='forward').length===4, 'DigitSpan 4 directos');
        console.assert(PLAN_TEST.filter(p=>p.dir==='backward').length===4, 'DigitSpan 4 inversos');
        console.log('%cTests b√°sicos OK','color:green');
      }catch(e){ console.warn('Tests b√°sicos con aviso', e); }
    })();

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

    // Registrar Service Worker para carga offline
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(console.warn);
    }
  </script>
</body>
</html>
