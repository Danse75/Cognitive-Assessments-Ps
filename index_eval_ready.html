<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Evaluaciones Psicol√≥gicas Online</title>
    <meta name="description" content="Bater√≠a breve: Stroop, Torre de Hanoi y Corsi. Ejecutable en GitHub Pages.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { theme: { extend: { fontFamily: { sans: ['ui-sans-serif','system-ui','Segoe UI','Roboto','Helvetica','Arial','Noto Sans','Apple Color Emoji','Segoe UI Emoji'] } } } }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>
    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;
      function cls(...xs){ return xs.filter(Boolean).join(" ") }
      function pct(x){ return Math.round(x*100) }
      function download(filename, text){
        const a=document.createElement('a');
        a.href='data:application/json;charset=utf-8,'+encodeURIComponent(text);
        a.download=filename; a.style.display='none';
        document.body.appendChild(a); a.click(); a.remove();
      }
      const SHEETS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw5ZI5_Ay43arDCcoVmOZU2Yr_PpYqvXe8-lbXeq4_Ymt2bTi0t60OL0r0-EASYoNSA/exec';
      function sendToSheets(payload){ try{ if(!SHEETS_ENDPOINT) return; fetch(SHEETS_ENDPOINT,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}); }catch(e){ console.warn('No se pudo enviar a Sheets',e) } }
      function accuracy(trials){ const v=trials.filter(t=>t.correct!==undefined); return v.length? v.filter(t=>!!t.correct).length/v.length : 0 }
      function meanRt(trials){ const v=trials.map(t=>t.rtMs).filter(x=>typeof x==='number'&&isFinite(x)); return v.length? Math.round(v.reduce((a,b)=>a+b,0)/v.length):null }
      function App(){
        const [view,setView]=useState('start');
        const [firstTask,setFirstTask]=useState('stroop');
        const [battery,setBattery]=useState(['stroop','hanoi','corsi']);
        const [participant,setParticipant]=useState({name:'',idNumber:''});
        const trialsRef=useRef([]);
        const [report,setReport]=useState(null);
        function begin(){
          if(!participant.name.trim()||!participant.idNumber.trim()) return alert('Ingresa nombre e ID.');
          const all=['stroop','hanoi','corsi'];
          setBattery([firstTask,...all.filter(k=>k!==firstTask)]);
          setView('consent');
        }
        function onAllDone(){
          const by=trialsRef.current.reduce((m,t)=>{(m[t.task]=m[t.task]||[]).push(t);return m}, {})
          const scores=Object.entries(by).map(([task,arr])=>({task,acc:accuracy(arr),rt:meanRt(arr)}));
          const payload={participant,completedAt:new Date().toISOString(),scores,trials:trialsRef.current};
          sendToSheets(payload); setReport(payload); setView('report');
          setTimeout(()=>document.getElementById('report-root')?.scrollIntoView({behavior:'smooth',block:'start'}),50)
        }
        return (
          <div className="min-h-screen bg-slate-50 text-slate-900">
            <div className="mx-auto max-w-3xl p-6 space-y-6">
              <header className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 rounded-xl bg-slate-900"/>
                  <div>
                    <h1 className="text-xl font-bold">Evaluaciones Psicol√≥gicas Online</h1>
                    <p className="text-xs text-slate-500">Ejecutable</p>
                  </div>
                </div>
                <span className="text-xs text-slate-500">{view.toUpperCase()}</span>
              </header>
              {view==='start' && (
                <section className="space-y-4">
                  <h2 className="text-lg font-semibold">Inicio</h2>
                  <p className="text-slate-600 text-sm">Completar√°s todas las pruebas. Elige con cu√°l deseas empezar e ingresa tus datos.</p>
                  <div className="grid gap-3 rounded-2xl border bg-white p-4">
                    <div className="grid gap-1">
                      <label className="text-xs text-slate-500">Nombres y apellidos</label>
                      <input className="rounded-xl border px-3 py-2" value={participant.name} onChange={e=>setParticipant(p=>({...p,name:e.target.value}))} placeholder="Nombres y apellidos"/>
                    </div>
                    <div className="grid gap-1">
                      <label className="text-xs text-slate-500">ID (c√©dula / ID number)</label>
                      <input className="rounded-xl border px-3 py-2" value={participant.idNumber} onChange={e=>setParticipant(p=>({...p,idNumber:e.target.value}))} placeholder="ID"/>
                    </div>
                    <div className="grid gap-1">
                      <label className="text-xs text-slate-500">Primera prueba</label>
                      <select className="rounded-xl border px-3 py-2" value={firstTask} onChange={e=>setFirstTask(e.target.value)}>
                        <option value="stroop">Stroop (interferencia)</option>
                        <option value="hanoi">Torre de Hanoi (planificaci√≥n)</option>
                        <option value="corsi">Corsi 3√ó3 (memoria visoespacial)</option>
                      </select>
                    </div>
                    <div className="flex gap-2 pt-2">
                      <button onClick={begin} className="rounded-xl bg-slate-900 text-white px-4 py-2">Continuar</button>
                    </div>
                    <ul className="text-sm text-slate-500 list-disc pl-5">
                      <li>Secuencia: Consentimiento ‚Üí Chequeo ‚Üí Tareas ‚Üí Informe</li>
                      <li>Compatible teclado y pantalla t√°ctil</li>
                    </ul>
                  </div>
                </section>
              )}
              {view==='consent' && <Consent onAccept={()=>setView('check')} onDecline={()=>setView('start')}/>}
              {view==='check'   && <Check onContinue={()=>setView('run')}/>}
              {view==='run'     && <Runner order={battery} onTrial={t=>trialsRef.current.push(t)} onDone={onAllDone}/>}
              {view==='report' && report && <Report payload={report} onRestart={()=>{trialsRef.current=[];setReport(null);setView('start')}}/>}
            </div>
          </div>
        )
      }
      function Consent({onAccept,onDecline}){
        const [ok,setOk]=useState(false)
        return (
          <section className="space-y-4">
            <h2 className="text-lg font-semibold">Consentimiento informado</h2>
            <div className="rounded-2xl border p-4 bg-white text-sm leading-relaxed text-slate-700 max-h-64 overflow-auto">
              <p><b>Prop√≥sito:</b> evaluar funciones cognitivas mediante tareas breves en l√≠nea.</p>
              <p><b>Duraci√≥n:</b> 8‚Äì12 minutos. Puede tomar descansos si lo necesita.</p>
              <p><b>Riesgos:</b> m√≠nimos (fatiga/aburrimiento).</p>
              <p><b>Datos:</b> se recogen tiempos de reacci√≥n, aciertos/errores y metadatos t√©cnicos.</p>
            </div>
            <label className="flex items-start gap-2 text-sm">
              <input type="checkbox" checked={ok} onChange={e=>setOk(e.target.checked)} className="mt-1"/>
              <span>He le√≠do y acepto participar.</span>
            </label>
            <div className="flex gap-2">
              <button disabled={!ok} onClick={onAccept} className={cls("rounded-xl px-4 py-2", ok?"bg-slate-900 text-white":"bg-slate-200 text-slate-400 cursor-not-allowed")}>Continuar</button>
              <button onClick={onDecline} className="rounded-xl border px-4 py-2">Cancelar</button>
            </div>
          </section>
        )
      }
      function Check({onContinue}){
        const [okKey,setOkKey]=useState(false)
        const [okScreen,setOkScreen]=useState(false)
        const [okFocus,setOkFocus]=useState(true)
        useEffect(()=>{ const w=()=>setOkScreen(innerWidth>=360&&innerHeight>=500); w(); addEventListener('resize',w); const vis=()=>setOkFocus(!document.hidden); document.addEventListener('visibilitychange',vis); return()=>{removeEventListener('resize',w);document.removeEventListener('visibilitychange',vis);} },[])
        useEffect(()=>{ const onKey=e=>{ if(e.code==='Space') setOkKey(true) }; addEventListener('keydown',onKey); return()=>removeEventListener('keydown',onKey)},[])
        const ok=okScreen&&okFocus
        return (
          <section className="space-y-3">
            <h2 className="text-lg font-semibold">Chequeo de dispositivo</h2>
            <ul className="text-sm text-slate-700 grid gap-1">
              <li>üì± Tama√±o de pantalla: {okScreen?"OK":"Muy peque√±o"}</li>
              <li>ü™ü Ventana activa: {okFocus?"OK":"Volviste desde otra pesta√±a"}</li>
              <li>‚å®Ô∏è Teclado: {okKey?"Barra espaciadora detectada":"Pulsa barra espaciadora para probar"}</li>
            </ul>
            <button disabled={!ok} onClick={onContinue} className={cls("rounded-xl px-4 py-2", ok?"bg-slate-900 text-white":"bg-slate-200 text-slate-400 cursor-not-allowed")}>Comenzar evaluaci√≥n</button>
          </section>
        )
      }
      function Runner({order,onTrial,onDone}){
        const [i,setI]=useState(0)
        const tasks=useMemo(()=>({stroop:Stroop,hanoi:Hanoi,corsi:Corsi}),[])
        const key=order[i]; const Comp=tasks[key]
        return (
          <section className="space-y-4">
            <div className="text-sm text-slate-500">Tarea {i+1} / {order.length}</div>
            <div className="rounded-2xl border bg-white p-4">
              {Comp? <Comp onTrial={onTrial} onDone={()=>{ if(i+1<order.length) setI(i+1); else onDone() }} /> : <div>No encontrada: {String(key)}</div>}
            </div>
          </section>
        )
      }
      function Stroop({onTrial,onDone}){
        const COLORS=[
          {name:'ROJO',   css:'text-red-600',   key:'R'},
          {name:'AZUL',   css:'text-blue-600',  key:'A'},
          {name:'VERDE',  css:'text-green-600', key:'V'},
          {name:'AMARILLO',css:'text-yellow-500',key:'M'}
        ];
        const N_TRIALS=24;
        const schedule=useRef([...Array(12).fill('word'),...Array(12).fill('color')]
          .map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]));
        useEffect(()=>{ const wc=schedule.current.filter(s=>s==='word').length; const cc=schedule.current.filter(s=>s==='color').length; console.assert(wc===12 && cc===12,'Stroop 12/12',wc,cc); },[])
        const [trial,setTrial]=useState(0)
        const [stim,setStim]=useState(null)
        const [mode,setMode]=useState('word')
        const t0=useRef(0)
        function pick(a){ return a[Math.floor(Math.random()*a.length)] }
        function mkStim(){ let w=pick(COLORS), i=pick(COLORS); while(i.name===w.name){ i=pick(COLORS) } return {word:w,ink:i} }
        useEffect(()=>{ next() },[])
        function next(){ if(trial>=N_TRIALS){ onDone(); return } setMode(schedule.current[trial]); setStim(mkStim()); t0.current=performance.now() }
        function answer(sel){ if(!stim) return; const rt=Math.round(performance.now()-t0.current); const correct = mode==='word' ? (sel.name===stim.word.name) : (sel.name===stim.ink.name); const task = mode==='word'?'stroop_word':'stroop_color'; onTrial({task,index:trial,stimulus:{word:stim.word.name,ink:stim.ink.name},response:{choice:sel.name},correct,rtMs:rt}); setTrial(t=>t+1); next() }
        return (
          <div className="grid place-items-center gap-6">
            <div className="text-slate-600 text-sm text-center">
              {mode==='word' ? <>Responde la <b>PALABRA</b> (12 ensayos) y el COLOR en otros 12.</> : <>Responde el <b>COLOR</b> (12 ensayos) y la PALABRA en otros 12.</>}
            </div>
            {stim && <div className={cls('text-5xl font-bold', stim.ink.css)}>{stim.word.name}</div>}
            <div className="w-full max-w-xl grid gap-3">
              <div className="text-sm text-slate-600 text-center">{mode==='word'? <>¬øQu√© <b>palabra</b> lees?</>:<>¬øQu√© <b>color</b> ves?</>}</div>
              <div className="flex flex-wrap justify-center gap-2">
                {COLORS.map(c=>
                  <button key={c.name} onClick={()=>answer(c)} className="rounded-xl border px-4 py-2 min-w-[6rem]">{c.name}</button>
                )}
              </div>
            </div>
            <div className="text-xs text-slate-500">Ensayo {trial+1} / 24</div>
          </div>
        )
      }
      function Hanoi({onTrial,onDone}){
        const N=3;
        const moveIdx=useRef(0);
        const tMove=useRef(performance.now());
        const roundsRef=useRef([[0,2],[1,2],[2,0],[2,1],[1,0],[1,2]]);
        const [round,setRound]=useState(0);
        const [pegs,setPegs]=useState([[],[],[]]);
        const [sel,setSel]=useState(null);
        function initRound(r){
          const [from]=roundsRef.current[r];
          const start=[[],[],[]];
          start[from]=Array.from({length:N},(_,i)=>N-i);
          setPegs(start); setSel(null); setRound(r);
        }
        useEffect(()=>{ initRound(0) },[]);
        function canPlace(d,t){ const top=t[t.length-1]; return top===undefined || top>d }
        function colorFor(d){ if(d===3) return '#eab308'; if(d===2) return '#16a34a'; return '#2563eb' }
        function click(pi){
          if(sel===null){ if(pegs[pi].length===0) return; setSel(pi); return }
          if(sel===pi){ setSel(null); return }
          const from=sel, to=pi;
          const src=pegs[from]; if(src.length===0){ setSel(null); return }
          const disc=src[src.length-1];
          const valid=canPlace(disc,pegs[to]);
          const rt=Math.round(performance.now()-tMove.current); tMove.current=performance.now();
          const [reqFrom, reqTo]=roundsRef.current[round];
          onTrial({task:'hanoi',index:moveIdx.current++,stimulus:{from,to,disc,state:pegs,required:[reqFrom,reqTo],round},response:{move:[from,to]},correct:valid,rtMs:rt});
          if(!valid){ setSel(null); return }
          setPegs(p=>{
            const n=p.map(a=>a.slice()); n[from].pop(); n[to].push(disc);
            const done = n[reqTo].length===N;
            if(done){ setTimeout(()=>{ if(round+1<roundsRef.current.length){ initRound(round+1) } else { onDone() } }, 350) }
            return n;
          });
          setSel(null);
        }
        const [reqFrom, reqTo]=roundsRef.current[round]||[0,2];
        return (
          <div className="space-y-4">
            <div className="text-slate-600 text-sm">Sigue la secuencia: <b>T1‚ÜíT3, T2‚ÜíT3, T3‚ÜíT1, T3‚ÜíT2, T2‚ÜíT1, T2‚ÜíT3</b>.</div>
            <div className="text-center text-xs text-slate-500">Ronda {round+1} / {roundsRef.current.length} ‚Äî Objetivo: <b>{`T${reqFrom+1} ‚Üí T${reqTo+1}`}</b></div>
            <div className="w-full overflow-x-auto">
              <div className="flex flex-nowrap gap-4 justify-center items-end min-w-[720px] mx-auto">
                {pegs.map((peg,pi)=>(
                  <button key={pi} onClick={()=>click(pi)} className={cls('relative h-56 w-60 rounded-xl border bg-white grid place-items-end', sel===pi && 'ring-2 ring-slate-900')} title={`Torre ${pi+1}`}>
                    <div className="absolute left-1/2 -translate-x-1/2 bottom-6 w-1 bg-slate-300 h-40"></div>
                    <div className="absolute left-3 right-3 bottom-4 h-2 bg-slate-300 rounded"></div>
                    <div className="w-full flex flex-col-reverse items-center gap-1 pb-6">
                      {peg.map((d,idx)=>(
                        <div key={idx} className="h-6 rounded text-[10px] text-white grid place-items-center" style={{width:`${40+d*15}%`,background:colorFor(d)}}>{d}</div>
                      ))}
                    </div>
                    <div className="absolute top-2 right-2 text-[10px] text-slate-400">{`T${pi+1}`}</div>
                  </button>
                ))}
              </div>
            </div>
            <div className="text-center text-xs text-slate-500">Selecciona <b>origen</b> y luego <b>destino</b>. Debes mover <b>todos</b> los discos desde <b>{`T${reqFrom+1}`}</b> hasta <b>{`T${reqTo+1}`}</b>.</div>
          </div>
        )
      }
      function Corsi({onTrial,onDone}){
        const [trial,setTrial]=useState(0); const [phase,setPhase]=useState('show'); const [seq,setSeq]=useState([]); const [flash,setFlash]=useState(null); const [resp,setResp]=useState([]); const timerRef=useRef(null)
        useEffect(()=>{ next(); return()=>clearInterval(timerRef.current) },[])
        function shuffle(a){ return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]) }
        function pickSeq(len){ const cells=Array.from({length:9},(_,i)=>i); return shuffle(cells).slice(0,len) }
        function next(){ if(trial>=9){ onDone(); return } const len=3+Math.floor(trial/3); const s=pickSeq(len); setSeq(s); setResp([]); setPhase('show'); let i=0; timerRef.current=setInterval(()=>{ setFlash(s[i]); i++; if(i>=s.length){ clearInterval(timerRef.current); setTimeout(()=>{ setFlash(null); setPhase('input') },600) } },700) }
        function press(i){ if(phase!=='input') return; const r=[...resp,i]; setResp(r); if(r.length===seq.length){ const correct=JSON.stringify(r)===JSON.stringify(seq); onTrial({task:'corsi',index:trial,stimulus:{seq},response:{seq:r},correct,rtMs:null}); setPhase('pause'); setTimeout(()=>{ setTrial(t=>t+1); next() },700) } }
        return (
          <div className="space-y-4">
            <div className="text-slate-600 text-sm">Repite la secuencia tocando los cuadros en el <b>mismo orden</b>. (9 ensayos)</div>
            <div className="grid grid-cols-3 gap-3 w-64 mx-auto">
              {Array.from({length:9},(_,i)=>{ const show=phase==='show'&&flash===i; const pressed=phase==='input'&&resp.includes(i); const clsCell=show?'bg-slate-900 border-slate-900':(pressed?'bg-emerald-500 border-emerald-600':'bg-white border-slate-300'); return <button key={i} onClick={()=>press(i)} className={cls('aspect-square rounded border transition-colors',clsCell)}/> })}
            </div>
            <div className="text-center text-xs text-slate-500">Ensayo {trial+1} / 9</div>
          </div>
        )
      }
      function Report({payload,onRestart}){
        const {participant,completedAt,scores,trials}=payload
        const by=useMemo(()=>{ const m={}; for(const t of trials){ (m[t.task]=m[t.task]||[]).push(t) } return m },[trials])
        return (
          <section id="report-root" className="space-y-4">
            <h2 className="text-lg font-semibold">Informe de resultados</h2>
            <div className="text-xs text-slate-500">{participant?.name||'Participante'} ¬∑ ID: {participant?.idNumber||'‚Äî'} ¬∑ {new Date(completedAt).toLocaleString()}</div>
            <div className="grid gap-3">
              {scores.map(s=> (
                <div key={s.task} className="rounded-2xl border p-4 bg-white">
                  <div className="font-semibold mb-1">{s.task.toUpperCase()}</div>
                  <div className="text-sm">Exactitud: {pct(s.acc)}%</div>
                  <div className="text-sm">RT medio: {s.rt??'‚Äî'} ms</div>
                  <details open className="text-xs text-slate-500 mt-2">
                    <summary>Ver ensayos ({by[s.task]?.length||0})</summary>
                    <div className="overflow-auto max-h-48 mt-1">
                      <table className="w-full text-xs">
                        <thead><tr><th className="text-left">#</th><th className="text-left">Stim</th><th className="text-left">Resp</th><th>‚úî</th><th className="text-right">RT</th></tr></thead>
                        <tbody>
                          {(by[s.task]||[]).map((t,i)=> (
                            <tr key={i} className="border-t">
                              <td>{t.index}</td>
                              <td className="pr-2"><code className="text-[10px]">{JSON.stringify(t.stimulus)}</code></td>
                              <td className="pr-2"><code className="text-[10px]">{JSON.stringify(t.response)}</code></td>
                              <td>{t.correct?'‚úî':'‚úñ'}</td>
                              <td className="text-right">{t.rtMs??'‚Äî'}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </details>
                </div>
              ))}
            </div>
            <div className="flex gap-2">
              <button onClick={()=>window.print()} className="rounded-xl border px-4 py-2">Imprimir / PDF</button>
              <button onClick={()=>download(`informe_${(participant?.idNumber||'anon')}.json`, JSON.stringify(payload,null,2))} className="rounded-xl bg-slate-900 text-white px-4 py-2">Exportar JSON</button>
              <button onClick={onRestart} className="rounded-xl border px-4 py-2">Nueva evaluaci√≥n</button>
            </div>
          </section>
        )
      }
      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
